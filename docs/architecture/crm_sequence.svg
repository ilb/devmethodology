<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1362px" preserveAspectRatio="none" style="width:1368px;height:1362px;" version="1.1" viewBox="0 0 1368 1362" width="1368px" zoomAndPan="magnify"><defs><filter height="300%" id="f19yjpyh7djgnc" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f19yjpyh7djgnc)" height="487.9219" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="13" y="604.2656"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="59" x2="59" y1="86.4063" y2="1275.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="413" x2="413" y1="86.4063" y2="1275.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="560.5" x2="560.5" y1="86.4063" y2="1275.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="671.5" x2="671.5" y1="86.4063" y2="1275.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="23" y="82.9883">BROWSER</text><ellipse cx="59" cy="13" fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M59,21 L59,48 M46,29 L72,29 M59,48 L46,63 M59,48 L72,63 " fill="none" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="23" y="1287.3477">BROWSER</text><ellipse cx="59" cy="1300.7656" fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M59,1308.7656 L59,1335.7656 M46,1316.7656 L72,1316.7656 M59,1335.7656 L46,1350.7656 M59,1335.7656 L72,1350.7656 " fill="none" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="389" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="396" y="70.9883">CRM</text><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="389" y="1274.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="396" y="1294.3477">CRM</text><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="514.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="521.5" y="70.9883">WORKFLOW</text><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="514.5" y="1274.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="521.5" y="1294.3477">WORKFLOW</text><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="635.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="642.5" y="70.9883">SERVICE</text><rect fill="#FEFECE" filter="url(#f19yjpyh7djgnc)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="635.5" y="1274.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="642.5" y="1294.3477">SERVICE</text><polygon fill="#A80036" points="401,118.6406,411,122.6406,401,126.6406,405,122.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="407" y1="122.6406" y2="122.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="66" y="117.4668">GET crm.getActivityForm.php?processId=...&amp;activityId=....</text><path d="M418,101.4063 L418,126.4063 L759,126.4063 L759,111.4063 L749,101.4063 L418,101.4063 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M749,101.4063 L749,111.4063 L759,111.4063 L749,101.4063 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="424" y="118.4668">адрес cтраницы, с которой начинает пользователь</text><polygon fill="#A80036" points="70,188.3438,60,192.3438,70,196.3438,66,192.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="412" y1="192.3438" y2="192.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="76" y="187.1699">200 OK</text><path d="M418,140.6406 L418,226.6406 L1056,226.6406 L1056,150.6406 L1046,140.6406 L418,140.6406 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1046,140.6406 L1046,150.6406 L1056,150.6406 L1046,140.6406 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="617" x="424" y="157.7012">СРМ создает операцию, на конкретного пользователя и под конкретное приложение, чтобы потом</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="424" y="172.9355">проверять права доступа.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="424" y="188.1699">интерфейс содержаший ссылку на WORKFLOW</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="424" y="203.4043">с указанием адреса для получения контекстной информации по операции</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="424" y="218.6387">callcontext/startProcess?contextUrl=...&amp;packageId=...&amp;processDefinitionId=...</text><polygon fill="#A80036" points="549,273.2813,559,277.2813,549,281.2813,553,277.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="555" y1="277.2813" y2="277.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="478" x="66" y="272.1074">GET callcontext/startProcess?contextUrl=...&amp;packageId=...&amp;processDefinitionId=...</text><path d="M566,240.8125 L566,295.8125 L1000,295.8125 L1000,250.8125 L990,240.8125 L566,240.8125 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M990,240.8125 L990,250.8125 L1000,250.8125 L990,240.8125 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="572" y="257.873">Пользователь переходит по предоставленной ссылке.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="572" y="273.1074">В переменной contextUrl содержится адрес для вызова контекста,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="572" y="288.3418">адрес содержит идентификатор вызова (callId)</text><polygon fill="#A80036" points="424,358.2188,414,362.2188,424,366.2188,420,362.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="418" x2="560" y1="362.2188" y2="362.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="430" y="357.0449">GET contextUrl</text><path d="M566,310.5156 L566,396.5156 L1094,396.5156 L1094,320.5156 L1084,310.5156 L566,310.5156 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1084,310.5156 L1084,320.5156 L1094,320.5156 L1084,310.5156 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="572" y="327.5762">В заголовках передает за кого пришло приложение за контекстом X-Remote-User</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="572" y="342.8105">Вызываем адрес для получения контекста.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="572" y="358.0449">СРМ должен проверить:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="572" y="373.2793">а) тот ли пользователь пришел за данными, которого СРМ отправлял</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="572" y="388.5137">б) то ли приложение пришло за данными, в которое СРМ отправлял</text><polygon fill="#A80036" points="549,504.0938,559,508.0938,549,512.0938,553,508.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="413" x2="555" y1="508.0938" y2="508.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="420" y="502.9199">200 OK</text><path d="M566,410.6875 L566,587.6875 L1246,587.6875 L1246,420.6875 L1236,410.6875 L566,410.6875 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1236,410.6875 L1236,420.6875 L1246,420.6875 L1236,410.6875 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="572" y="427.748">Получаем контекстную информацию. Ответ должен содержать как минимум</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="572" y="442.9824">callbackUrl -  адрес для возврата в родительское приложение.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="572" y="458.2168">Мы обсуждали, что это может  быть набор ссылок для отображения в интерфейсе</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="572" y="473.4512">Необходимо быть очень внимательным и не передавать информацию</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="572" y="488.6855">которая представляет из себя предметную область СРМ. Если мы сделаем это,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="550" x="572" y="503.9199">то все другие приложения вплетающие эту WORKFLOW в свою работу будут вынуждены</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="572" y="519.1543">знать ее. Это приведет к плохой архитектуре.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="572" y="534.3887">С другой стороны мы понимаем, что в данном пример</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="572" y="549.623">наш минипроцесс работает с сервисом обработки ПТС, и каждый кто будет работать с ним</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="629" x="572" y="564.8574">должен будет знать в какой то части предметную область ПТС. Таким образом например номер ПТС</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="659" x="572" y="580.0918">- это вполне сквозная предметная область для всех участников и передавать ее в контексте не страшно.</text><path d="M13,604.2656 L86,604.2656 L86,611.2656 L76,621.2656 L13,621.2656 L13,604.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="487.9219" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="13" y="604.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="28" y="617.3262">loop</text><polygon fill="#A80036" points="70,638.7344,60,642.7344,70,646.7344,66,642.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="560" y1="642.7344" y2="642.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="76" y="637.5605">HEADER Location: service_url</text><polygon fill="#A80036" points="660,680.5859,670,684.5859,660,688.5859,664,684.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="666" y1="684.5859" y2="684.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="66" y="679.4121">GET service_url?contextUrl=...</text><path d="M677,655.7344 L677,695.7344 L1256,695.7344 L1256,665.7344 L1246,655.7344 L677,655.7344 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1246,655.7344 L1246,665.7344 L1256,665.7344 L1246,655.7344 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="558" x="683" y="672.7949">Теперь уже WORKFLOW вперекидывает пользователя на страницу сервиса работы с ПТС</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="683" y="688.0293">Все тоже самое что делал в свое время СРМ</text><polygon fill="#A80036" points="572,727.4375,562,731.4375,572,735.4375,568,731.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="566" x2="671" y1="731.4375" y2="731.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="578" y="726.2637">GET contextUrl</text><path d="M677,710.2031 L677,735.2031 L1073,735.2031 L1073,720.2031 L1063,710.2031 L677,710.2031 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1063,710.2031 L1063,720.2031 L1073,720.2031 L1063,710.2031 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="683" y="727.2637">тоже идем за контекстной информацией таким же способом</text><polygon fill="#A80036" points="660,761.6719,670,765.6719,660,769.6719,664,765.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="561" x2="666" y1="765.6719" y2="765.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="568" y="760.498">200 OK</text><polygon fill="#A80036" points="660,841.6094,670,845.6094,660,849.6094,664,845.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="666" y1="845.6094" y2="845.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="66" y="840.4355">POST service_url</text><path d="M677,778.6719 L677,894.6719 L1240,894.6719 L1240,788.6719 L1230,778.6719 L677,778.6719 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1230,778.6719 L1230,788.6719 L1240,788.6719 L1230,778.6719 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="683" y="795.7324">Собственно работа сервиса.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="683" y="810.9668">Пользователь заполняет форму, и отправляет данные на сервер</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="683" y="826.2012">сервис сохраняет данные в базе считаем что этим и ограничивается</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="683" y="841.4355">его функциональность. соответственно работа выполнена,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="683" y="856.6699">пора возвращаться назад.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="683" y="871.9043">Делаем редирект на предоставленный ранее в контексте callback_url</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="542" x="683" y="887.1387">в переменные которого добавляем адрес для получения результатов работы result_url</text><polygon fill="#A80036" points="70,921.5469,60,925.5469,70,929.5469,66,925.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="671" y1="925.5469" y2="925.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="76" y="920.373">HEADER Location: callbackUrl?contextUrl=...</text><polygon fill="#A80036" points="549,950.7813,559,954.7813,549,958.7813,553,954.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="555" y1="954.7813" y2="954.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="66" y="949.6074">GET callbackUrl?contextUrl=...</text><polygon fill="#A80036" points="660,980.0156,670,984.0156,660,988.0156,664,984.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="561" x2="666" y1="984.0156" y2="984.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="568" y="978.8418">GET contextUrl</text><polygon fill="#A80036" points="572,1044.7188,562,1048.7188,572,1052.7188,568,1048.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="566" x2="671" y1="1048.7188" y2="1048.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="578" y="1043.5449">200 OK</text><path d="M677,997.0156 L677,1083.0156 L1338,1083.0156 L1338,1007.0156 L1328,997.0156 L677,997.0156 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1328,997.0156 L1328,1007.0156 L1338,1007.0156 L1328,997.0156 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="683" y="1014.0762">Мини машина процессов забирает результаты работы сервиса.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="453" x="683" y="1029.3105">обрабатывает их и решает завершить активити и запустить следующую,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="683" y="1044.5449">а может решить закончить минимпроцесс и вернуться в CRM</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="535" x="683" y="1059.7793">при запросе результата тоже передается X-Remote-User чтобы сервис мог проверить</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="640" x="683" y="1075.0137">то ли приложение пришло за результатом, в рамках которого его получили и с тем ли пользователем.</text><polygon fill="#A80036" points="70,1116.4219,60,1120.4219,70,1124.4219,66,1120.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="560" y1="1120.4219" y2="1120.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="76" y="1115.248">HEADER Redirect-to initial callbackUrl</text><polygon fill="#A80036" points="401,1145.6563,411,1149.6563,401,1153.6563,405,1149.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="59" x2="407" y1="1149.6563" y2="1149.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="66" y="1144.4824">GET callbackUrl?contextUrl=...</text><polygon fill="#A80036" points="549,1174.8906,559,1178.8906,549,1182.8906,553,1178.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="413" x2="555" y1="1178.8906" y2="1178.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="420" y="1173.7168">GET contextUrl</text><polygon fill="#A80036" points="424,1209.125,414,1213.125,424,1217.125,420,1213.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="418" x2="560" y1="1213.125" y2="1213.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="430" y="1207.9512">200 OK</text><path d="M566,1191.8906 L566,1216.8906 L836,1216.8906 L836,1201.8906 L826,1191.8906 L566,1191.8906 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M826,1191.8906 L826,1201.8906 L836,1201.8906 L826,1191.8906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="572" y="1208.9512">Получаем наконец то результаты в СРМ</text><polygon fill="#A80036" points="70,1248.3594,60,1252.3594,70,1256.3594,66,1252.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="412" y1="1252.3594" y2="1252.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="76" y="1247.1855">200 OK</text><path d="M418,1231.125 L418,1256.125 L790,1256.125 L790,1241.125 L780,1231.125 L418,1231.125 " fill="#FBFB77" filter="url(#f19yjpyh7djgnc)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M780,1231.125 L780,1241.125 L790,1241.125 L780,1231.125 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="424" y="1248.1855">СРМ дальше уже что-то решает с полученными данными</text><!--MD5=[687391786ddfc320526c47a289c75e50]
@startuml
actor BROWSER
BROWSER->CRM : GET crm.getActivityForm.php?processId=...&activityId=....
note right
    адрес cтраницы, с которой начинает пользователь
end note
CRM->BROWSER : 200 OK
note right
    СРМ создает операцию, на конкретного пользователя и под конкретное приложение, чтобы потом
    проверять права доступа.
    интерфейс содержаший ссылку на WORKFLOW
    с указанием адреса для получения контекстной информации по операции
    callcontext/startProcess?contextUrl=...&packageId=...&processDefinitionId=...
end note
BROWSER->WORKFLOW : GET callcontext/startProcess?contextUrl=...&packageId=...&processDefinitionId=...
note right
    Пользователь переходит по предоставленной ссылке.
    В переменной contextUrl содержится адрес для вызова контекста,
    адрес содержит идентификатор вызова (callId)
end note
WORKFLOW->CRM : GET contextUrl
note right
    В заголовках передает за кого пришло приложение за контекстом X-Remote-User
    Вызываем адрес для получения контекста.
    СРМ должен проверить:
    а) тот ли пользователь пришел за данными, которого СРМ отправлял
    б) то ли приложение пришло за данными, в которое СРМ отправлял
end note
CRM->WORKFLOW : 200 OK
note right
    Получаем контекстную информацию. Ответ должен содержать как минимум
    callbackUrl -  адрес для возврата в родительское приложение.
    Мы обсуждали, что это может  быть набор ссылок для отображения в интерфейсе
    Необходимо быть очень внимательным и не передавать информацию
    которая представляет из себя предметную область СРМ. Если мы сделаем это,
    то все другие приложения вплетающие эту WORKFLOW в свою работу будут вынуждены
    знать ее. Это приведет к плохой архитектуре.
    С другой стороны мы понимаем, что в данном пример
    наш минипроцесс работает с сервисом обработки ПТС, и каждый кто будет работать с ним
    должен будет знать в какой то части предметную область ПТС. Таким образом например номер ПТС
    - это вполне сквозная предметная область для всех участников и передавать ее в контексте не страшно.
end note
loop
WORKFLOW->BROWSER : HEADER Location: service_url
BROWSER->SERVICE : GET service_url?contextUrl=...
note right
    Теперь уже WORKFLOW вперекидывает пользователя на страницу сервиса работы с ПТС
    Все тоже самое что делал в свое время СРМ
end note
SERVICE->WORKFLOW : GET contextUrl
note right
    тоже идем за контекстной информацией таким же способом
end note
WORKFLOW->SERVICE : 200 OK
BROWSER->SERVICE : POST service_url
note right
    Собственно работа сервиса.
    Пользователь заполняет форму, и отправляет данные на сервер
    сервис сохраняет данные в базе считаем что этим и ограничивается
    его функциональность. соответственно работа выполнена,
    пора возвращаться назад.
    Делаем редирект на предоставленный ранее в контексте callback_url
    в переменные которого добавляем адрес для получения результатов работы result_url
end note
SERVICE->BROWSER : HEADER Location: callbackUrl?contextUrl=...
BROWSER->WORKFLOW : GET callbackUrl?contextUrl=...
WORKFLOW->SERVICE : GET contextUrl
SERVICE->WORKFLOW : 200 OK
note right
    Мини машина процессов забирает результаты работы сервиса.
    обрабатывает их и решает завершить активити и запустить следующую,
    а может решить закончить минимпроцесс и вернуться в CRM
    при запросе результата тоже передается X-Remote-User чтобы сервис мог проверить
    то ли приложение пришло за результатом, в рамках которого его получили и с тем ли пользователем.
end note
end
WORKFLOW->BROWSER : HEADER Redirect-to initial callbackUrl
BROWSER->CRM : GET callbackUrl?contextUrl=...
CRM->WORKFLOW : GET contextUrl
WORKFLOW->CRM : 200 OK
note right
    Получаем наконец то результаты в СРМ
end note
CRM->BROWSER : 200 OK
note right
    СРМ дальше уже что-то решает с полученными данными
end note
@enduml

PlantUML version 1.2020.09(Sun May 10 14:51:06 SAMT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.9+11-suse-lp152.2.6.2-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: ru
Country: RU
--></g></svg>